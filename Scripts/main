//REVISADO
function planSchedule() {
  const now = getNow_(); // Momento (con offset)

  // --- Force evaluation of the CUT flags (they are updated inside these calls) ---
  // buildFreeSlots_ -> getFixedEventsFromLoggedDatabase_ -> readLoggedCalendarEvents_ (updates LAST_CALENDAR_WRITE_MOVED)
  // getPendingTasks_ -> readLoggedTasks_ (updates LAST_TASKS_WRITE_MOVED)

  const horizon = getDynamicHorizonEnd_(now);
  // This call updates LAST_CALENDAR_WRITE_MOVED internally
  const espaciosLibre = buildFreeSlots_(now, horizon);

  // This call updates LAST_TASKS_WRITE_MOVED internally
  const tareasPendientes = getPendingTasks_(now);

  // Exams don't affect the "what changed" decision; they only matter for the full run
  const examEvents = buildExamPriorityArray_();

  // NEW: Proyectos (weekly hours -> intervals until horizon)
  const projectEvents = buildProjectPriorityArray_(now, horizon);

  const hasNewFixedLogs = (LAST_CALENDAR_WRITE_MOVED || 0) > 0;
  const hasNewTaskLogs  = (LAST_TASKS_WRITE_MOVED || 0) > 0;

  // CASE 1: New fixed event(s) were added (I/J/K/L)
  // -> run full pipeline exactly as before
  if (hasNewFixedLogs || hasNewTaskLogs) {
    const eventTotal = [...tareasPendientes, ...examEvents, ...projectEvents];

    if (eventTotal.length > 0) {
      const eventosOrdenados = sortEventsByUrgency_(eventTotal);

      if (!espaciosLibre) {
        Logger.log("No hay espacios libres");
        return;
      }
      clearAllCalendars();
      scheduleTasksIntoFreeSlots_(espaciosLibre, eventosOrdenados);
    }
    importWeekFromToday();
    return;
  }

  // CASE 3: Nothing new (everything already in A/B/C/D or G)
  Logger.log("planSchedule: No new fixed logs (I..L) and no new task logs (M). Returning without scheduling.");
  return;
}

function clearAllCalendars(){
  const now = getNow_(); // Momento (con offset)
  const end = getDynamicHorizonEnd_(now);
  clearAutomaticEvents_(fetchCalendar_("Estudio"), now, end);
  clearAutomaticEvents_(fetchCalendar_("Proyecto"), now, end);
  clearAutomaticEvents_(fetchCalendar_("Tareas"), now, end);

}
